;(function(){var render=template.compile($('#T_Spot').html());var orginName='';function Spot(data,map,area){BaseAddr.call(this,data,map)
this.area=area;this.id=data.id;this._data=data;this.anchorIcon='http://img2.tuniucdn.com/site/file/deyonUserCenter/images/spot-icon.png';this.init();}
function temp(){};temp.prototype=BaseAddr.prototype;Spot.prototype=new temp();$.extend(Spot.prototype,{init:function(){var self=this;var data=self._data;data.info=data.info||{};var ele=$(render(self._data));var comload=$('.tuc-track-right');var editBtn=ele.find('.J_EditSpot');var delBtn=ele.find('.J_SpotDelete');var commentWrap=ele.find('.area-list-intro');var starWrap=ele.find('.area-list-star');var editHtml=$('#T_EditSpot').html();var wrapEle,editStar,star,stars;this.addAnchor({x:data.x,y:data.y});this.addInfoWindow();this.ele=ele;comload.find('.J_SpotComment').each(function(){var Val=$.trim($(this).attr('data-name'));var len=Val.replace(/[^\x00-\xff]/g,"01").length;if(len>80){Val=Val.slice(0,80).replace(/([^x00-xff])/g,"$1a").slice(0,80).replace(/([^x00-xff])a/g,"$1")+'...';}
$(this).html(Val)});if(data.info&&data.info.star){stars=data.info.star;}else{stars=0;}
star=new Star({wrap:starWrap,level:stars});editBtn.click(function(){var editComment=parseInt($(this).parents('div.J_City').find('.J-CountComment').html());orginName=$.trim($(this).parents('div .area-list-text').find('p.J_SpotComment').attr('data-name'));var editCommentHtml=$(this).parents('div .area-list-text').find('p.J_SpotComment').html().replace(/\s+/g,"");var editNum;if(editCommentHtml=='写点什么吧~'){editNum=editComment;}else{editNum=editComment-1;}
var editCommentDom=$(this).parents('div.J_City').find('.J-CountComment');$.layer({type:1,title:['','background:none;height:0;border:0'],border:[0],closeBtn:[0],btns:2,btn:['保 存','取 消'],area:['320px','250px'],page:{html:editHtml},success:function(wrap){var stars;wrap=$(wrap);wrapEle=wrap;wrap.find('.J_SpotEditTitle').text(data.name);editStar=new Star({wrap:wrap.find('.area-list-star'),level:data.info.star||0,disabled:false});if(!data.info.comment){wrap.find('.comment-spot').attr('placeholder','写点什么吧~');wrap.find('.comment-spot').val('');}else{wrap.find('.comment-spot').attr('placeholder',' ');wrap.find('.comment-spot').val(data.info.comment);}
wrap.find('.comment-spot').on('keydown keyup',function(){wrap.find('.tuc5-error').hide();});},yes:function(index){var _text=wrapEle.find('.comment-spot').val();var level=editStar.get();wrapEle.find('.tuc5-error').hide();if(_text.length>800){wrapEle.find('.tuc5-error').show();}else{dataService.editSpot({id:data.id,star:level,comment:_text},function(ajaxData){if(ajaxData&&ajaxData.code==200){if(_text!=''){editComment=editNum+1;}else{if(editComment>1){editComment--;}else{editComment=0;}}
commentWrap.attr('data-name',_text)
commentWrap.attr('title',_text)
data.info.star=level;data.info.comment=_text;var len=_text.replace(/[^\x00-\xff]/g,"01").length;if(len>80){_text=_text.slice(0,80).replace(/([^x00-xff])/g,"$1a").slice(0,80).replace(/([^x00-xff])a/g,"$1")+'...';}
orginName='';commentWrap.html(_text||'写点什么吧~');star.set(level);editCommentDom.html(editComment);}});layer.close(index);}},no:function(index){var wrap=$(wrap);wrap.find('.comment-spot').val('');layer.close(index);}});});delBtn.click(function(){var delSpot=parseInt($(this).parents('div .J_City').find('.J-CountSpot').html())-1;var delComment=parseInt($(this).parents('div .J_City').find('.J-CountComment').html());var commentHtml=$(this).parents('div .area-list-text').find('.J_SpotComment').html().replace(/\s+/g,"");if(commentHtml!='写点什么吧~'){delComment=delComment-1;}
var delSpotDom=$(this).parents('div .J_City').find('.J-CountSpot');var delCommentDom=$(this).parents('div .J_City').find('.J-CountComment');$.layer({type:1,title:['友情提示','background:#5fb859;height:25px;line-height:25px;border:none;color:#fff;border-radius:5px 5px 0 0;'],border:[0],closeBtn:[1,true],btns:2,btn:['确 认','取 消'],area:['253px','132px'],page:{html:'<p class="changename">确定删除此条足迹吗？</p>'},yes:function(index){dataService.delVSpot({id:data.id},function(data){if(data){if(window.isIndex){location.href=footprint_url;}else{self.trigger('remove');delSpotDom.html(delSpot);delCommentDom.html(delComment);}}});layer.close(index);},no:function(index){layer.close(index);}});});ele.hover(function(){ele.addClass('hovered');},function(){ele.removeClass('hovered');});}});window.Spot=Spot;})();