M.define("dialog/confirm",function(c,e){var g=c("dialog/Dialog"),a='<div id="popup_container" class="popup-box new-popbox"><a class="close-btn _j_close _j_false"><i></i></a><div class="pop-ico" id="popup_icon"><i class="i2"></i></div><div class="pop-ctn"><p class="hd _j_content"></p><p class="bd _j_detail"></p></div><div class="pop-btns"><a role="button" tabindex="0" class="popbtn popbtn-cancel popbtn-half _j_close _j_false">&nbsp;取消&nbsp;</a><a role="button" tabindex="0" class="popbtn popbtn-submit popbtn-half _j_close _j_true">&nbsp;确定&nbsp;</a></div></div>',h=M.extend(function(k){var j={width:420,content:"请输入内容",background:"#000",bgOpacity:0.7,PANEL_CLASS:"pop_no_margin",reposition:true,impl:"Confirm",layerZIndex:10000};k=M.mix(j,k);h.$parent.call(this,k);this.bindEvents()},g),d=null,b=$.noop,i=$.noop,f=false;M.mix(h.prototype,{tpl:a,setConfirmTitle:function(j){this.setContent(j)},setConfirmContent:function(j){this.getPanel().find("._j_detail").text(j)},bindEvents:function(){this.getPanel().on("click","._j_false",function(){f=false}).on("click","._j_true",function(){f=true}).on("keydown","._j_false",function(j){if(j.keyCode==13){$(this).trigger("click")}else{if(j.keyCode==39){$(this).next().focus()}}}).on("keydown","._j_true",function(j){if(j.keyCode==13){$(this).trigger("click")}else{if(j.keyCode==37){$(this).prev().focus()}}})}});e.pop=function(k,j,l){if(!d){d=new h();M.Event(d).on("afterhide",function(){if(f){b()}else{i()}});M.Event(d).on("aftershow",function(){d.getPanel().find("._j_true").focus()})}d.getLayer().toFront();if(M.isObject(k)){d.setConfirmTitle(k.title);d.setConfirmContent(k.content)}else{d.setConfirmTitle(k);d.setConfirmContent("")}if(typeof j=="function"){b=j}else{b=$.noop}if(typeof l=="function"){i=l}else{i=$.noop}d.show();return d}});M.define("/js/common/Comment",function(e,f,b){var c=e("StarRating"),j=e("InputListener"),a=e("Select"),g=e("dialog/alert"),k=e("dialog/confirm"),h=e("/js/common/CommentPicUploader"),i=e("/js/common/CommentPicDialog"),m='<dd class="_j_picitem" data-imgstr="${imgstr}" data-picid="${id}">                        <div class="place">                            <div class="img"><img class="_j_edit_src" src="${src}" style="width:120px;height:120px"></div>                            <div class="title"><h4 class="_j_edit_title">${title}</h4></div>                            <div class="mask-operate"><a class="btn-edit _j_edit_dd"></a><a class="btn-remove _j_remove_dd"></a></div>                        </div>                    </dd>';function d(n){this.container=$(n.container);this.delPicIds=[];this.init();M.Event.fire("comment form loaded",{poi_id:this.container.find('input[name="poiid"]').val()})}M.mix(d.prototype,{init:function(){this.bindEvents(this.container)},bindEvents:function(n){var p=n.find("._j_commentdialogform");var u=new c({context:n,blockSelector:"._j_rankblock",starCountSelector:"._j_starcount",starItemSelector:"._j_starlist a"});M.Event(u).on("onrating",function(y){var A=y.block,x=A.next("._j_startip"),z=A.find("._j_starlist a").eq(y.star-1).attr("title");x.text(z).data("originText",z);A.children("input").val(y.star)});M.Event(u).on("enterrating",function(y){var A=y.block,x=A.next("._j_startip"),z=A.find("._j_starlist a").eq(y.star-1).attr("title");x.text(z)});M.Event(u).on("leaverating",function(y){var z=y.block,x=z.next("._j_startip");x.text(x.data("originText"))});n.find("._j_rankblock").each(function(){if($(this).data("star")>0){var y=$(this).find("._j_starlist a").eq($(this).data("star")-1).attr("title");$(this).next("._j_startip").text(y)}var x=$(this).next("._j_startip");x.data("originText",x.text())});var o=n.find("._j_commentarea"),q=n.find("._j_commentcounttip");j.listen(o,function(x){l(q,$.trim(o.val()).length)});var v=new a({valueBox:n.find("._j_timevaluebox"),dropTrigger:n.find("._j_droptrigger"),dropListCnt:n.find("._j_timeselectdroplist")});n.find("._j_viewbox").click(function(x){if($(x.target).is("._j_viewbox")){setTimeout(function(){n.find("._j_droptrigger").trigger("click")},1)}});n.on("click","._j_radio",function(z){var A=$(z.currentTarget),y=A.attr("name"),x=$('input[name="'+y+'"]');if($(this).hasClass("on")){$(this).removeClass("on");x.val("")}else{$(this).addClass("on").siblings().removeClass("on");x.val($(this).data("value"))}});n.on("click","._j_checkbox","click",function(z){var A=$(z.currentTarget),y=A.attr("name");if($(this).hasClass("select")){$(this).removeClass("select")}else{$(this).addClass("select")}var x=[];$(this).siblings().add(this).filter(".select").each(function(){x.push($(this).data("value"))});$('input[name="'+y+'"]').val(x.join(","))});n.find("._j_needinitselect").each(function(){var z=$(this),y=z.data("type"),x=z.attr("name"),A=$.trim(z.val());if(A){if(y=="checkbox"){A=M.map(A.split(","),function(B){return +B})}$('._j_selectitem[name="'+x+'"]').each(function(){if(y=="checkbox"){if(M.indexOf(A,$(this).data("value"))!==-1){$(this).addClass("select")}}else{if(A==$(this).data("value")){$(this).addClass("on")}}})}});n.on("click","._j_submit",function(x){p.submit()});var r=$("#_j_addpicbtns"),t=r.children("a"),w=new h({trigger:t}),s=p.find("._j_piclist");M.Event(w).on("imgs committed",function(x){var y=x.imgs.reverse();M.forEach(y,function(z){$.tmpl(m,z).insertAfter(r)});M.Event.fire("comment form add imgs")});M.Event.on("out img insert",function(x){var y=x.imgs.reverse();M.forEach(y,function(z){$.tmpl(m,z).insertAfter(r)});M.Event.fire("comment form add imgs")});s.on("click","._j_remove_dd",$.proxy(function(y){var z=$(y.currentTarget),x=z.closest("._j_picitem");k.pop("确认删除该图片吗？",$.proxy(function(){if(x.data("picid")>0){this.delPicIds.push(x.data("picid"))}x.remove()},this))},this)).on("click","._j_edit_dd",function(B){var C=$(B.currentTarget),x=C.closest("._j_picitem"),A=x.find("._j_edit_title"),z=x.find("._j_edit_src"),D=x.data("picid");var y=new i({edit:true,imgs:[{id:D,imgstr:x.data("imgstr"),src:z.attr("src"),title:A.text()}]});M.Event(y).on("imgs committed",function(E){var F=E.imgs;if(F.length==1&&F[0].id==D){A.text(F[0].title);$.post("/path/ajax.php",{act:"updateAlbum",id:D,title:F[0].title})}});y.show()});p.submit($.proxy(function(E){if(p.data("locking")){return false}E.preventDefault();var G=p.data("typeid"),A=p.serializeArray(),x=true;for(var C=0,D=A.length;C<D;C++){var H=A[C],B=$(p.get(0)[H.name]),F=$.trim(H.value);if(B.attr("essential")){if(!F){x=false;g.pop("请先完善"+B.data("inputname"));break}}if(B.data("minlen")){if(F.length<B.data("minlen")){x=false;g.pop(B.data("inputname")+"不能少于"+B.data("minlen")+"个字");break}}if(B.data("maxlen")){if(F.length>B.data("maxlen")){x=false;g.pop(B.data("inputname")+"不能超过"+B.data("maxlen")+"个字");break}}if(B.data("type")=="number"){F=+F;if(!M.is(F,"Number")&&!isNaN(F)){x=false;g.pop(B.data("inputname")+"需要填写数字");break}}}if(x){p.data("locking",true);if(this.delPicIds.length){if(!p.children('[name="del_aids"]').length){p.append('<input type="hidden" name="del_aids" value="" />')}p.children('[name="del_aids"]').val(this.delPicIds.join(","))}else{p.children('[name="del_aids"]').val("")}var y=p.find("._j_picitem"),z=[];y.each(function(I,J){J=$(J);if(!J.data("picid")){z.push({img:J.data("imgstr"),title:J.find("._j_edit_title").text()})}});if(z.length){if(!p.children('[name="add_imgs"]').length){p.append('<input type="hidden" name="add_imgs" value="" />')}p.children('[name="add_imgs"]').val(JSON.stringify(z))}else{p.children('[name="add_imgs"]').val("")}$.post(p.attr("action"),p.serialize(),function(I){if(!I.error&&I.data){var J=I.data;J.rank=p.get(0).rank.value;J.comment=p.get(0).comment.value;M.Event.fire("comment published",{info:J})}else{if(I.error){g.pop('<span style="padding:10px 30px; display:inline-block">'+(I.error.msg||"暂时无法点评，请稍后再试.")+"</a>")}}setTimeout(function(){p.data("locking",false)},100)},"json")}},this))}});function l(n,o){if(o>0&&o<15){n.css("color","#f00").text("还需要输入"+(15-o)+"个字")}else{if(o>2000){n.css("color","#f00").text("超出"+(o-2000)+"个字")}else{n.css("color","").text("15-1000个字，已输入"+o+"个字")}}}b.exports=d});